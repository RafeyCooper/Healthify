{% extends "layout.html" %}

{% block title %}Prediction Details - Healthify{% endblock %}

{% block content %}
<style>
    .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 30px;
        align-items: flex-start;
    }

    .result-summary-card {
        background: var(--card-bg);
        padding: 40px;
        border-radius: 15px;
        box-shadow: var(--shadow);
        text-align: center;
        position: sticky;
        top: 20px;
    }

    .result-icon {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto 20px auto;
    }

    .result-icon i {
        font-size: 3rem;
        color: #fff;
    }

    .result-summary-card.positive .result-icon { background-color: #e74c3c; }
    .result-summary-card.negative .result-icon { background-color: #27ae60; }

    .result-text {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
    }
    
    .result-text.positive { color: #e74c3c; }
    .result-text.negative { color: #27ae60; }

    .confidence-text {
        font-size: 1.2rem;
        color: var(--text-light);
        margin-bottom: 25px;
    }

    .confidence-text strong {
        font-weight: 700;
        color: var(--text-dark);
    }

    /* Card for both tabular and image inputs */
    .input-card {
        background: var(--card-bg);
        padding: 30px;
        border-radius: 15px;
        box-shadow: var(--shadow);
    }
    .input-card h3 {
        margin-bottom: 20px;
        font-size: 1.5rem;
    }
    .input-card img {
        max-width: 100%;
        border-radius: 10px;
        border: 1px solid var(--border-color);
    }
    
    .input-list {
        list-style-type: none;
        padding-left: 0;
        margin: 0;
    }

    .input-list li {
        display: flex;
        justify-content: space-between;
        padding: 15px 0;
        border-bottom: 1px solid var(--border-color);
        font-size: 1rem;
    }

    .input-list li:last-child {
        border-bottom: none;
    }

    .input-list .key {
        font-weight: 600;
        color: var(--text-dark);
    }

    .input-list .value {
        color: var(--text-light);
    }
    
    .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: transparent;
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        padding: 10px 20px;
        border-radius: 50px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .back-btn:hover {
        background: var(--primary-color);
        color: #fff;
    }

</style>

<header>
    <div class="header-title">
        <h1>Prediction Details</h1>
        <p>A detailed view of your {{ prediction.disease_type.replace('_', ' ').title() }} prediction from <span class="local-date" data-timestamp="{{ prediction.timestamp.isoformat() }}">Loading date...</span>.</p>
    </div>
</header>

<div class="details-grid">
    <!-- Left Column: Result Summary -->
    {% set is_positive = 'High' in prediction.prediction_result or 'Positive' in prediction.prediction_result or 'PNEUMONIA' in prediction.prediction_result %}
    <div class="result-summary-card {{ 'positive' if is_positive else 'negative' }}">
        <div class="result-icon">
            <i class="fas {{ 'fa-exclamation-triangle' if is_positive else 'fa-check-circle' }}"></i>
        </div>
        <p class="result-text {{ 'positive' if is_positive else 'negative' }}">{{ prediction.prediction_result }}</p>
        <p class="confidence-text">Model Confidence: <strong>{{ prediction.confidence_probability }}%</strong></p>
    </div>

    <!-- Right Column: Input Details (UPDATED) -->
    <div class="input-card">
        <h3>Inputs Provided</h3>
        
        {# Check if the prediction was based on an image #}
        {% if prediction.input_features.image_path %}
            <img src="{{ url_for('static', filename=prediction.input_features.image_path) }}" alt="User uploaded image for analysis">
        
        {# Otherwise, display the tabular data #}
        {% else %}
            <ul class="input-list">
                {% for key, value in prediction.input_features.items() %}
                    {% set formatted_key = key.replace('_', ' ').replace('diseaseType', '').title() %}
                    {% if formatted_key %}
                    <li>
                        <span class="key">{{ formatted_key }}</span>
                        <span class="value">{{ value }}</span>
                    </li>
                    {% endif %}
                {% endfor %}
            </ul>
        {% endif %}
    </div>
</div>

<div style="margin-top: 40px; text-align: center;">
    <a href="{{ url_for('history') }}" class="back-btn"><i class="fas fa-arrow-left"></i> Back to History</a>
</div>
{% endblock %}
